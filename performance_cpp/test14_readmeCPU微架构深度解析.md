# CPU å¾®æ¶æ„æ·±åº¦è§£æ
## ç¼“å­˜å±‚çº§ Â· åˆ†æ”¯é¢„æµ‹ Â· ä¹±åºæ‰§è¡Œ Â· æµæ°´çº¿ä¼˜åŒ–

---

## ğŸ“š æ¦‚è§ˆ

`test14.cpp` æ˜¯ä¸€ä»½ **40 ç« ã€7 å¤§ä¸“é¢˜** çš„ CPU å¾®æ¶æ„å®Œæ•´æ•™ç¨‹ï¼Œæ¯ç« åŒ…å«ï¼š

- ç²¾ç¡®çš„ ASCII æ¶æ„å›¾ + ä¸­æ–‡æ³¨é‡Š
- å¯ç¼–è¯‘è¿è¡Œçš„åŸºå‡†æµ‹è¯•ä»£ç 
- ç¡¬ä»¶å‚æ•°æ•°æ®è¡¨ (Intel / AMD / Apple Silicon)
- è°ƒè¯•å·¥å…·å‘½ä»¤ (perf / VTune / LLVM-MCA)

```bash
# ç¼–è¯‘è¿è¡Œ (Linux)
g++ -std=c++17 -O2 -march=native -pthread -o test14 test14.cpp
./test14

# Windows MSVC
cl /std:c++17 /O2 /EHsc /arch:AVX2 test14.cpp
```

---

## ç›®å½• (40 ç«  / 7 å¤§ä¸“é¢˜)

| ä¸“é¢˜ | ç« èŠ‚ | æ ¸å¿ƒä¸»é¢˜ |
|------|------|----------|
| ä¸€ã€æµæ°´çº¿åŸºç¡€ | 1â€“4 | 5çº§æµæ°´çº¿ã€è¶…æ ‡é‡ã€å†’é™©ã€æ°”æ³¡æµ‹é‡ |
| äºŒã€ç¼“å­˜å±‚çº§ | 5â€“13 | L1/L2/L3ã€ç¼“å­˜è¡Œã€å…³è”åº¦ã€MESIã€False Sharing |
| ä¸‰ã€TLB ä¸è™šæ‹Ÿå†…å­˜ | 14â€“16 | 4çº§é¡µè¡¨ã€å¤§é¡µã€PCID |
| å››ã€åˆ†æ”¯é¢„æµ‹ | 17â€“24 | BHT/BTBã€TAGEã€é—´æ¥åˆ†æ”¯ã€æ— åˆ†æ”¯æŠ€æœ¯ |
| äº”ã€ä¹±åºæ‰§è¡Œ | 25â€“32 | ROBã€RATã€ä¿ç•™ç«™ã€Store Bufferã€ILP |
| å…­ã€å‰ç«¯ä¼˜åŒ– | 33â€“36 | I-Cacheã€Î¼op Cache (DSB)ã€LSDã€ä»£ç å¯¹é½ |
| ä¸ƒã€æ€§èƒ½è®¡æ•°å™¨ | 37â€“40 | PMUã€Top-Downã€VTune/Î¼Profã€ä¼˜åŒ–æ¸…å• |

---

## ä¸€ã€CPU æµæ°´çº¿åŸºç¡€ç¯‡ (ç¬¬ 1â€“4 ç« )

### ç¬¬ 1 ç« ï¼šç»å…¸ 5 çº§æµæ°´çº¿

ç»å…¸ RISC æµæ°´çº¿äº”ä¸ªé˜¶æ®µï¼š

```
IF â†’ ID â†’ EX â†’ MEM â†’ WB
å–æŒ‡   è¯‘ç    æ‰§è¡Œ   è®¿å­˜    å†™å›
```

**ç†æƒ³çŠ¶æ€**ï¼šæ¯ä¸ª cycle å®Œæˆä¸€æ¡æŒ‡ä»¤ (CPI = 1)ã€‚

**ç°ä»£ CPU æµæ°´çº¿æ·±åº¦å¯¹æ¯”**ï¼š

| å¤„ç†å™¨ | çº§æ•° | å¤‡æ³¨ |
|--------|------|------|
| ç»å…¸ RISC | 5 | æ•™ç§‘ä¹¦æ¨¡å‹ |
| Pentium 4 | 31 | NetBurstï¼Œåˆ†æ”¯æƒ©ç½šæå¤§ |
| Sandy Bridge | 14â€“19 | å¹³è¡¡æ·±åº¦ä¸ IPC |
| Zen 4 | ~19 | AMD ç°ä»£æ¶æ„ |
| Golden Cove | ~20 | Intel 12th Gen+ |
| Apple M2 (P-core) | ~16 | å®½å‘å°„ + æµ…æµæ°´çº¿ |

**å…³é”®æƒè¡¡**ï¼šæµæ°´çº¿è¶Šæ·± â†’ ä¸»é¢‘è¶Šé«˜ï¼Œä½†åˆ†æ”¯æƒ©ç½šè¶Šå¤§ (~15â€“25 cycles)ã€‚  
**ç°ä»£è¶‹åŠ¿**ï¼šé€‚åº¦æ·±åº¦ (14â€“20) + è¶…å®½å‘å°„ (6â€“8 wide) è€Œéç®€å•åŠ æ·±ã€‚

---

### ç¬¬ 2 ç« ï¼šè¶…æ ‡é‡ä¸å¤šå‘å°„

**è¶…æ ‡é‡**ï¼šæ¯ cycle åŒæ—¶å‘å°„å¤šæ¡æŒ‡ä»¤ã€‚

```
æ ‡é‡:   inst1 inst2 inst3 inst4 â†’ æ¯æ¡é¡ºåºè¿›å…¥æµæ°´çº¿
4-wide: inst1+inst2+inst3+inst4 â†’ åŒä¸€æ‹å…¨éƒ¨å–/è¯‘/æ‰§ï¼
```

**ç°ä»£ CPU å‘å°„å®½åº¦**ï¼š

| æ¶æ„ | å‘å°„å®½åº¦ | æ‰§è¡Œç«¯å£é…ç½® |
|------|----------|-------------|
| Zen 4 | 6-wide | 4 ALU + 3 LD + 2 ST |
| Golden Cove | 6-wide | 5 ALU + 3 LD + 2 ST |
| Apple Firestorm | 8-wide | 6 ALU + 3 LD + 2 ST |
| Neoverse V2 | 10-wide | ARM æœåŠ¡å™¨ |

**å®æµ‹å‘ç°**ï¼ˆtest14 ch2 benchmarkï¼‰ï¼š
- 4 è·¯ç‹¬ç«‹ç´¯åŠ  vs ä¸²è¡Œä¾èµ–é“¾ï¼Œé€Ÿåº¦å·®å¼‚å¯è¾¾ **3â€“5Ã—**
- IPC å®é™…çº¦ 2â€“4ï¼ˆå—é™äºä¾èµ–ã€Cache missã€åˆ†æ”¯ï¼‰

**IPC å››å¤§é™åˆ¶å› ç´ **ï¼š
1. æ•°æ®ä¾èµ– â†’ æ— æ³•å¹¶è¡Œæ‰§è¡Œ
2. ç¼“å­˜ miss â†’ ç­‰å¾… DRAM ~200 cycles
3. åˆ†æ”¯é¢„æµ‹å¤±è´¥ â†’ æ¸…ç©ºæµæ°´çº¿
4. æ‰§è¡Œç«¯å£å†²çª â†’ æŸç«¯å£é¥±å’Œ

---

### ç¬¬ 3 ç« ï¼šæµæ°´çº¿å†’é™©

ä¸‰ç±»å†’é™©ï¼š

**1. æ•°æ®å†’é™© (RAW â€” Read After Write)**ï¼Œæœ€å¸¸è§ï¼š

```asm
ADD R1, R2, R3   ; R1 è¿˜æ²¡å†™å›
SUB R4, R1, R5   ; ä½†ç«‹åˆ»éœ€è¦ R1 â†’ åœé¡¿!
```

ç°ä»£ CPU è§£å†³æ–¹æ¡ˆï¼š**å‰é€’ (Forwarding)**ï¼ŒEX é˜¶æ®µç»“æœç›´æ¥æ—è·¯åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ— éœ€ç­‰ WBã€‚

**2. æ§åˆ¶å†’é™©**ï¼šåˆ†æ”¯æ–¹å‘åœ¨ EX æ‰ç¡®å®šï¼Œå‰é¢å·²å–äº†è‹¥å¹²æŒ‡ä»¤ â†’ **åˆ†æ”¯é¢„æµ‹**ï¼ˆè¯¦è§ç¬¬å››ç¯‡ï¼‰ã€‚

**3. ç»“æ„å†’é™©**ï¼šä¸¤æ¡æŒ‡ä»¤ç«äº‰åŒä¸€ç¡¬ä»¶å•å…ƒã€‚ç°ä»£ CPU èµ„æºå……è¶³ï¼Œå‡ ä¹ä¸å‘ç”Ÿã€‚

> åå­—ä¾èµ– (WAW / WAR) é€šè¿‡ **å¯„å­˜å™¨é‡å‘½å** æ¶ˆé™¤ï¼ˆè¯¦è§ç¬¬ 26 ç« ï¼‰ã€‚

---

### ç¬¬ 4 ç« ï¼šæµæ°´çº¿æ°”æ³¡ä¸åœé¡¿æµ‹é‡

**å®æµ‹ä¸‰ç§ä¾èµ–é“¾é•¿åº¦**ï¼ˆtest14 ch4 benchmarkï¼‰ï¼š

```
é“¾é•¿=1 (4è·¯ç‹¬ç«‹): ~0.25 ns/iter  â† è¶…æ ‡é‡å¹¶è¡Œ
é“¾é•¿=2 (ä¸²è¡Œ):   ~0.50 ns/iter  â† æ¯æ­¥ç­‰å‰ä¸€æ­¥
é“¾é•¿=4 (ä¸²è¡Œ):   ~1.00 ns/iter  â† ä¾èµ–é“¾æ·±åº¦Ã—å»¶è¿Ÿ
```

**perf æŸ¥çœ‹åœé¡¿**ï¼š

```bash
perf stat -e cycles,instructions,\
  stalled-cycles-frontend,stalled-cycles-backend \
  ./app
```

| åœé¡¿ç±»å‹ | æ¥æº | ä¼˜åŒ–æ–¹å‘ |
|----------|------|----------|
| Frontend Stall | I-Cache missã€DSB missã€è¯‘ç ç“¶é¢ˆ | ä»£ç ç´§å‡‘ã€ä»£ç å¯¹é½ |
| Backend Stall | æ•°æ®ä¾èµ–ã€D-Cache missã€ç«¯å£é¥±å’Œ | ILPã€é¢„å–ã€SIMD |

---

## äºŒã€ç¼“å­˜å±‚çº§ç¯‡ (ç¬¬ 5â€“13 ç« )

### ç¬¬ 5 ç« ï¼šL1/L2/L3 å»¶è¿Ÿå®æµ‹

**ç¼“å­˜å±‚çº§å…¨æ™¯**ï¼š

```
    Core
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ L1D  48KB   â”‚   4â€“5 cycles  (~1 ns)
   â”‚ L1I  32KB   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ L2   1.25MB â”‚   ~12 cycles  (~4 ns)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚ (å…±äº«)
   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
   â”‚ L3   30MB   â”‚   40â€“50 cycles (~12 ns)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
   â”‚   DRAM      â”‚   200+ cycles (~65 ns)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Intel Golden Cove / Zen 4 å‚æ•°**ï¼š

| å±‚çº§ | å¤§å° | å»¶è¿Ÿ | å¸¦å®½ | å…³è”åº¦ |
|------|------|------|------|--------|
| L1D | 48 KB | 4â€“5 cyc | 2Ã—64B/cyc | 12-way |
| L1I | 32 KB | â€” | 32B/cyc | 8-way |
| L2 | 1.25 MB | 12 cyc | 64B/cyc | 10-way |
| L3 | 30 MB | 40â€“50 cyc | 32B/cyc | 12â€“16-way |
| DRAM | GBs | 200+ cyc | ~25 GB/s | â€” |

**å®æµ‹è§„å¾‹**ï¼ˆtest14 ch5 benchmarkï¼Œæ­¥é•¿ = ç¼“å­˜è¡Œï¼‰ï¼š

```
    4 KB:  ~1 ns  â†’ L1 å‘½ä¸­
   64 KB:  ~4 ns  â†’ L2 å‘½ä¸­  (L1 æ”¾ä¸ä¸‹)
  256 KB:  ~5 ns  â†’ L2 å‘½ä¸­
 4096 KB: ~12 ns  â†’ L3 å‘½ä¸­
16384 KB: ~40 ns  â†’ DRAM
```

> **æ ¸å¿ƒç»“è®º**ï¼šDRAM æ¯” L1 æ…¢ **40â€“50Ã—**ï¼Œæ•°æ®å±€éƒ¨æ€§çš„é‡è¦æ€§ä¸å¯ä½ä¼°ã€‚

---

### ç¬¬ 6 ç« ï¼šç¼“å­˜è¡Œè¯¦è§£

ç¼“å­˜æœ€å°æ“ä½œå•ä½ = **64å­—èŠ‚ç¼“å­˜è¡Œ**ã€‚

åœ°å€åˆ†è§£ (32KB L1D, 8-way, 64B line)ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tag (é«˜ä½)  â”‚ Index (6b) â”‚ Offset (6b)  â”‚
â”‚  å”¯ä¸€æ ‡è¯†è¡Œ  â”‚ å®šä½ç»„     â”‚ è¡Œå†…åç§»     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç©ºé—´å±€éƒ¨æ€§**ï¼šè®¿é—® `data[0]` â†’ æ•´è¡Œ (`data[0..15]`) è‡ªåŠ¨åŠ è½½ã€‚

**æ­¥é•¿é™·é˜±å®æµ‹**ï¼ˆtest14 ch6ï¼‰ï¼š

```
è¿ç»­è®¿é—® (stride=1):         ~0.25 ns/elem  â† å®Œç¾åˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§
æ­¥é•¿=16 (stride=cache line): ~0.5 ns/access â† æ¯è¡Œåªç”¨ 1 ä¸ªå…ƒç´ 
æ­¥é•¿=256:                    ~3 ns/access   â† æ¥è¿‘ L2 å»¶è¿Ÿ
```

**ä¼˜åŒ–åŸåˆ™**ï¼š
- ä¼˜å…ˆé€‰æ‹© `std::vector` ç­‰è¿ç»­å­˜å‚¨
- é¿å…æŒ‡é’ˆè¿½é€ (linked list)
- SoA (Struct of Arrays) > AoS (Array of Structs) for SIMD

---

### ç¬¬ 7 ç« ï¼šç¼“å­˜å…³è”åº¦ä¸å†²çª Miss

**2çš„å¹‚æ­¥é•¿é—®é¢˜**ï¼ˆå†²çª miss å®æµ‹ï¼Œtest14 ch7ï¼‰ï¼š

```
æ­¥é•¿ 4096 (å†²çª!):    ~8 ns/access  â† å…¨æ‰“åŒä¸€ set
æ­¥é•¿ 4096+64 (é”™å¼€): ~1 ns/access  â† åˆ†æ•£åˆ°ä¸åŒ set
```

**æ ¹å› **ï¼š32KB L1D 8-way â†’ 64 ç»„ï¼Œç›¸é‚» `4096B` çš„åœ°å€æ˜ å°„åˆ°åŒä¸€ set â†’ 9 ä¸ªæ•°ç»„å°±é©±é€äº† 8-wayã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```cpp
float matrix[1024][1024];      // åˆ—è®¿é—®å…¨å†²çª
float matrix[1024][1024+16];   // +padding é”™å¼€ set
```

---

### ç¬¬ 8 ç« ï¼šæ›¿æ¢ç­–ç•¥

| ç­–ç•¥ | åŸç† | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| LRU | é©±é€æœ€ä¹…æœªè®¿é—®çš„è¡Œ | L1/L2 |
| PLRU (ä¼ªLRU) | äºŒå‰æ ‘å†³ç­–ï¼Œæ¯ way 1 bit | ç°ä»£ CPU L1/L2 |
| RRIP | 2â€“3 bit å†å¼•ç”¨é—´éš”é¢„æµ‹ | **Intel L3** |
| Random | éšæœºé€‰æ‹© | æŸäº› ARM |

**RRIP çš„ä¼˜åŠ¿**ï¼šå¤§æ•°ç»„æ‰«æä¸ä¼šå†²æ‰çƒ­æ•°æ®ï¼Œé€‚åˆ LLCã€‚

---

### ç¬¬ 9 ç« ï¼šå†™ç­–ç•¥

**Write-Backï¼ˆç°ä»£ CPU é»˜è®¤ï¼‰** + **éä¸´æ—¶å†™ (Non-Temporal Store)**ï¼š

```cpp
// ç»•è¿‡ç¼“å­˜ç›´æ¥å†™å†…å­˜ï¼Œé€‚åˆåªå†™ä¸è¯»çš„å¤§å—æ•°æ®
_mm_stream_si128((__m128i*)ptr, val);
_mm_sfence();
```

é€‚ç”¨ï¼šæ•°æ®å†™å®Œä¸ä¼šå†è¯» + å†™æ»¡æ•´ä¸ªç¼“å­˜è¡Œ + é¡ºåºè®¿é—®ï¼ˆåˆ©ç”¨ WCBï¼‰ã€‚

---

### ç¬¬ 10 ç« ï¼šMESI/MOESI ç¼“å­˜ä¸€è‡´æ€§

**MESI åè®®å››çŠ¶æ€**ï¼ˆIntelï¼‰ï¼š

| çŠ¶æ€ | å«ä¹‰ |
|------|------|
| M (Modified) | æœ¬æ ¸ç‹¬å ï¼Œå·²ä¿®æ”¹ |
| E (Exclusive) | æœ¬æ ¸ç‹¬å ï¼Œæœªä¿®æ”¹ |
| S (Shared) | å¤šæ ¸å…±æœ‰ï¼Œæœªä¿®æ”¹ |
| I (Invalid) | æ— æ•ˆ |

**è·¨æ ¸å»¶è¿Ÿ**ï¼š

| åœºæ™¯ | å»¶è¿Ÿ |
|------|------|
| åŒæ ¸ L1 hit | ~4 cycles |
| **è·¨æ ¸ MESI snoop** | **~40 cycles** |
| è·¨ CCD/Die (AMD) | ~60 cycles |
| è·¨ NUMA èŠ‚ç‚¹ | ~150 cycles |

> **MESI ä¹’ä¹“** = False Sharing çš„æ ¹å› ã€‚

---

### ç¬¬ 11 ç« ï¼šFalse Sharing æ·±åº¦å®æµ‹

```cpp
struct NoPad {
    std::atomic<int64_t> a{0};
    std::atomic<int64_t> b{0};  // åŒä¸€ 64B è¡Œ
};

struct WithPad {
    alignas(64) std::atomic<int64_t> a{0};
    alignas(64) std::atomic<int64_t> b{0};  // ç‹¬ç«‹ç¼“å­˜è¡Œ
};
```

**å®æµ‹**ï¼ˆ2 çº¿ç¨‹ï¼Œå„é€’å¢ 1000 ä¸‡æ¬¡ï¼‰ï¼š

```
NoPad  (false sharing):    ~250 ms
WithPad (æ—  false sharing): ~30 ms
æ€§èƒ½å·®å¼‚: ~8Ã—
```

**æ£€æµ‹**ï¼š`perf c2c record ./app && perf c2c report`

---

### ç¬¬ 12 ç« ï¼šç¼“å­˜å‹å¥½çš„æ•°æ®ç»“æ„

**é“¾è¡¨ vs æ•°ç»„å®æµ‹**ï¼ˆéå† 100 ä¸‡èŠ‚ç‚¹ï¼‰ï¼š

```
std::vector:  ~0.4 ms  â† é¡ºåºåŠ è½½ï¼Œç¡¬ä»¶é¢„å–
std::list:    ~8.0 ms  â† æŒ‡é’ˆéšæœºè·³è·ƒï¼Œæ¯æ¬¡ cache miss
```

**AoS vs SoA**ï¼š
```cpp
// AoS: éå† x éœ€è¦è·³è¿‡ y/z/mass
struct Particle { float x, y, z, mass; };

// SoA: æ‰€æœ‰ x è¿ç»­ â†’ SIMD å‹å¥½
struct Particles { std::vector<float> x, y, z, mass; };
```

---

### ç¬¬ 13 ç« ï¼šç¼“å­˜ Thrashing ä¸åˆ†å—

**åˆ†å—çŸ©é˜µä¹˜æ³•** (TILE â‰ˆ 64 æˆ– 128) â†’ 3Ã— ä»¥ä¸Šæå‡ï¼ˆN=512 æ—¶ï¼‰ï¼š

```cpp
// åˆ†å—: å·¥ä½œé›† = 3Ã—TILEÂ²Ã—sizeof(float) < L2 å¤§å°
for (ii+=TILE) for (jj+=TILE) for (kk+=TILE)
  for i in [ii..ii+TILE]: for j ...: for k ...:
    C[i][j] += A[i][k] * B[k][j];
```

---

## ä¸‰ã€TLB ä¸è™šæ‹Ÿå†…å­˜ç¯‡ (ç¬¬ 14â€“16 ç« )

### ç¬¬ 14 ç« ï¼šTLB å±‚çº§ä¸ Page Walk

**4 çº§é¡µè¡¨ (x86-64, 4KB é¡µ)**ï¼š

```
è™šæ‹Ÿåœ°å€ 48 bit:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PML4   â”‚  PDP   â”‚   PD   â”‚   PT   â”‚  Offset    â”‚
â”‚ 9 bits â”‚ 9 bits â”‚ 9 bits â”‚ 9 bits â”‚  12 bits   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| å±‚çº§ | æ¡ç›®æ•° | å‘½ä¸­å»¶è¿Ÿ |
|------|--------|----------|
| L1 DTLB | 96 entries (4KB) | 1 cycle |
| L2 STLB | 2048 entries | ~8 cycles |
| Page Walk | â€” | **~100â€“200 cycles** |

---

### ç¬¬ 15 ç« ï¼šå¤§é¡µå¯¹ TLB çš„å½±å“

| é¡µå¤§å° | L2 STLB è¦†ç›– |
|--------|-------------|
| 4 KB | 2048 Ã— 4KB = **8 MB** |
| **2 MB** | 1024 Ã— 2MB = **2 GB** |
| 1 GB | 16 Ã— 1GB = **16 GB** |

```bash
# é…ç½®å¤§é¡µ
echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

# C++ ç”³è¯·
void* p = mmap(NULL, size, PROT_READ|PROT_WRITE,
               MAP_ANON|MAP_PRIVATE|MAP_HUGETLB, -1, 0);
```

---

### ç¬¬ 16 ç« ï¼šPCID ä¸ TLB åˆ·æ–°

**PCID (Process Context ID)**ï¼ˆIntel Broadwell+ï¼‰ï¼šæ¯ TLB æ¡ç›®å¸¦ 12-bit è¿›ç¨‹ ID â†’ è¿›ç¨‹åˆ‡æ¢æ— éœ€å®Œå…¨åˆ·æ–° TLBã€‚

**KPTIï¼ˆSpectre/Meltdown ç¼“è§£ï¼‰æ—  PCID æ—¶**ï¼šæ¯æ¬¡ syscall å®Œå…¨åˆ· TLB â†’ æ€§èƒ½æŸå¤± 30â€“40%ã€‚æœ‰ PCID åä»£ä»·é™è‡³ ~5%ã€‚

---

## å››ã€åˆ†æ”¯é¢„æµ‹ç¯‡ (ç¬¬ 17â€“24 ç« )

### ç¬¬ 17 ç« ï¼šåˆ†æ”¯é¢„æµ‹å™¨åŸç†

| ç»„ä»¶ | å¤§å° | åŠŸèƒ½ |
|------|------|------|
| **BHT/PHT** | ~16Kâ€“64K entries | 2-bit è®¡æ•°å™¨é¢„æµ‹ taken/not-taken |
| **BTB** | 4096â€“12288 entries | ç¼“å­˜åˆ†æ”¯ç›®æ ‡åœ°å€ |
| **RAS** | 16â€“32 entries | ä¸“é—¨é¢„æµ‹ `RET` è¿”å›åœ°å€ |
| **Loop Predictor** | 64â€“256 entries | è¯†åˆ«å¾ªç¯é€€å‡ºè®¡æ•° |

---

### ç¬¬ 18â€“19 ç« ï¼š2-bit è®¡æ•°å™¨ä¸ GShare

**2-bit é¥±å’Œè®¡æ•°å™¨**ï¼š

```
å¼ºè·³(11) â†â†’ å¼±è·³(10) â†â†’ å¼±ä¸è·³(01) â†â†’ å¼ºä¸è·³(00)
è¿ç»­ä¸¤æ¬¡åå‘æ‰ç¿»è½¬ â†’ å¾ªç¯æœ«å°¾ä¸ç«‹å³è¯¯é¢„æµ‹
```

**GShare ä¸¤çº§è‡ªé€‚åº”**ï¼š`BHR XOR PC â†’ PHT ç´¢å¼• â†’ 2-bit è®¡æ•°å™¨`ï¼Œå‡†ç¡®ç‡ 95â€“97%ã€‚

---

### ç¬¬ 20 ç« ï¼šTAGE é¢„æµ‹å™¨

**å‡ ä½•çº§æ•°å†å²é•¿åº¦**ï¼šT0(æ— å†å²) + T1(2) + T2(4) + T3(8) + T4(16) + T5(32) + T6(64) + T7(128)ã€‚

| CPU | å‡†ç¡®ç‡ (SPEC) |
|-----|--------------|
| 2-bit è®¡æ•°å™¨ | ~85â€“90% |
| GShare | ~95â€“97% |
| **TAGE** | **~97â€“99%** |

---

### ç¬¬ 21 ç« ï¼šé—´æ¥åˆ†æ”¯é¢„æµ‹ï¼ˆè™šå‡½æ•°ï¼‰

å¤šæ€åˆ†æ´¾ â†’ ç±»å‹æ•°é‡è¶Šå¤š â†’ IBTB é¢„æµ‹å¤±è´¥ç‡è¶Šé«˜ã€‚

**ä¼˜åŒ–**ï¼šæŒ‰ç±»å‹æ’åºå¯¹è±¡åæ‰¹é‡å¤„ç†ï¼Œè¿ç»­è°ƒç”¨åŒç±»å‹ â†’ BTB å‘½ä¸­ç‡æ¥è¿‘ 100%ã€‚

---

### ç¬¬ 22â€“23 ç« ï¼šåˆ†æ”¯ Miss ä»£ä»·ä¸æ— åˆ†æ”¯æŠ€æœ¯

**åˆ†æ”¯ Miss ä»£ä»·å®æµ‹**ï¼š

```
æ’åºæ•°ç»„: ~1.2 ms  (miss <0.1%)
éšæœºæ•°ç»„: ~4.5 ms  (miss ~25%)  â†’ 3.75Ã— å·®è·
```

**æ— åˆ†æ”¯æŠ€æœ¯åº“**ï¼ˆé«˜ miss rate >5% æ—¶ä½¿ç”¨ï¼‰ï¼š

```cpp
int branchless_abs(int x)    { int mask=x>>31; return (x+mask)^mask; }
int branchless_min(int a,int b) { return b+((a-b)&((a-b)>>31)); }
int branchless_select(bool c,int a,int b) { return b^((a^b)&-(int)c); }
```

---

### ç¬¬ 24 ç« ï¼šlikely/unlikely/PGO

```cpp
if (x > 0) [[likely]] { ... }   // C++20
if (LIKELY(x > 0)) ...           // GCC/Clang __builtin_expect

// PGO
g++ -O2 -fprofile-generate -o app app.cpp   // æ’æ¡©
./app < input                                // æ”¶é›†
g++ -O2 -fprofile-use -o app app.cpp        // ä¼˜åŒ–
```

---

## äº”ã€ä¹±åºæ‰§è¡Œç¯‡ (ç¬¬ 25â€“32 ç« )

### ç¬¬ 25 ç« ï¼šä¹±åºæ‰§è¡Œå¼•æ“å…¨æ™¯

```
å–æŒ‡ â†’ è¯‘ç  â†’ å¯„å­˜å™¨é‡å‘½å â†’ åˆ†é…ROB/RS
              â†“
        ä¿ç•™ç«™ (RS) â€” æ“ä½œæ•°å°±ç»ª?
              â†“
        æ‰§è¡Œå•å…ƒ (ALUÃ—4, LDÃ—3, STÃ—2)
              â†“
        ROB æ ‡è®°å®Œæˆ â†’ æŒ‰åºé€€å½¹
```

**ROB å¤§å°**ï¼šZen 4=320, Golden Cove=512, Apple Firestorm=~630ã€‚

---

### ç¬¬ 26 ç« ï¼šå¯„å­˜å™¨é‡å‘½å (RAT)

**æ¶ˆé™¤ WAW/WAR åå­—ä¾èµ–**ï¼Œç‰©ç†å¯„å­˜å™¨ ~280 ä¸ª (Zen 4)ã€‚

**Move Elimination**ï¼š`MOV R1, R2` ä»…æ›´æ–° RAT æ˜ å°„ â†’ é›¶ Î¼opï¼Œé›¶å»¶è¿Ÿã€‚

---

### ç¬¬ 27â€“28 ç« ï¼šä¿ç•™ç«™ä¸ ROB

| æ¶æ„ | RS | ROB |
|------|-----|-----|
| Zen 4 | 96 | 320 |
| Golden Cove | 160+ | 512 |
| Firestorm | ~330 | ~630 |

**DRAM miss (~200 cycles) å¤§äº ROB çª—å£èƒ½éšè—çš„é‡ â†’ ROB å¡«æ»¡ â†’ å‰ç«¯åœé¡¿**ã€‚è¿™é©±åŠ¨äº† ROB å®¹é‡æŒç»­å¢å¤§ã€‚

---

### ç¬¬ 29 ç« ï¼šStore Buffer ä¸å†…å­˜æ¶ˆæ­§

- **Store-Load Forwarding**ï¼šLoad åœ°å€åœ¨ Store Buffer ä¸­ â†’ ç›´æ¥è½¬å‘ï¼Œæ— éœ€è®¿é—®ç¼“å­˜
- x86 TSOï¼šStore Buffer å¯¼è‡´å…¶ä»–æ ¸æš‚æ—¶ä¸å¯è§ â†’ `MFENCE` åˆ·æ–° Store Buffer

---

### ç¬¬ 30 ç« ï¼šæ‰§è¡Œç«¯å£ä¸æŒ‡ä»¤å»¶è¿Ÿ

**Intel Golden Cove å…³é”®æŒ‡ä»¤**ï¼š

| æŒ‡ä»¤ | å»¶è¿Ÿ | åå |
|------|------|------|
| ADD/XOR | 1 cyc | 4/cyc |
| IMUL (32b) | 3 cyc | 1/cyc |
| IDIV (64b) | 20â€“90 | â€” |
| FP ADD/MUL | 4â€“5 cyc | 2/cyc |
| L1 Load | 4â€“5 cyc | 3/cyc |

---

### ç¬¬ 31â€“32 ç« ï¼šILP æœ€å¤§åŒ–

**å¤šè·¯ç´¯åŠ å™¨ç ´è§£å¾ªç¯æºå¸¦ä¾èµ–**ï¼ˆFP ADD å»¶è¿Ÿ4cyc, åå2/cyc â†’ éœ€ 8 è·¯ï¼‰ï¼š

```cpp
double s0=0,s1=0,s2=0,s3=0,s4=0,s5=0,s6=0,s7=0;
for (int i=0; i<N; i+=8) {
    s0+=data[i];   s1+=data[i+1]; s2+=data[i+2]; s3+=data[i+3];
    s4+=data[i+4]; s5+=data[i+5]; s6+=data[i+6]; s7+=data[i+7];
}
double sum = ((s0+s1)+(s2+s3)) + ((s4+s5)+(s6+s7));
```

---

## å…­ã€å‰ç«¯ä¼˜åŒ–ç¯‡ (ç¬¬ 33â€“36 ç« )

### ç¬¬ 34 ç« ï¼šÎ¼op Cache (DSB)

| æ¶æ„ | DSB å®¹é‡ | å¸¦å®½ |
|------|----------|------|
| Sandy Bridge | 1536 Î¼ops | 4/cyc |
| Skylake | 2048 Î¼ops | 6/cyc |
| Golden Cove | 4096 Î¼ops | 6â€“8/cyc |
| Zen 4 (Op Cache) | 6144 Î¼ops | 8/cyc |

**æ£€æµ‹**ï¼š`perf stat -e idq.dsb_uops,idq.mite_uops ./app`ï¼ˆç›®æ ‡ DSB æ¯”ä¾‹ > 80%ï¼‰

---

### ç¬¬ 35â€“36 ç« ï¼šLSD ä¸ä»£ç å¯¹é½

**LSD**ï¼šå¾ªç¯ä½“ â‰¤ 64 Î¼ops (Intel) â†’ ç›´æ¥ä» LSD ä¾›ç»™ï¼Œå®Œå…¨ç»•è¿‡ I-Cacheã€‚

**BOLT** äºŒè¿›åˆ¶å¸ƒå±€ä¼˜åŒ–ï¼š
```bash
perf record -e cycles:u -j any,u -o perf.data -- ./app
perf2bolt ./app -p perf.data -o app.fdata
llvm-bolt ./app -o app.bolt -data app.fdata -reorder-blocks=cache+
```

---

## ä¸ƒã€æ€§èƒ½è®¡æ•°å™¨ä¸åˆ†æç¯‡ (ç¬¬ 37â€“40 ç« )

### ç¬¬ 38 ç« ï¼šTop-Down åˆ†ææ³• (TMAM)

```
Total Slots
â”œâ”€ Frontend Bound  (I-Cache Miss / DSB Miss)
â”œâ”€ Backend Bound
â”‚  â”œâ”€ Memory Bound (L1/L2/L3/DRAM Miss)
â”‚  â””â”€ Core Bound  (ç«¯å£é¥±å’Œ / ä¾èµ–é“¾)
â”œâ”€ Bad Speculation (åˆ†æ”¯ Misprediction)
â””â”€ Retiring        (ç†æƒ³çŠ¶æ€ï¼Œç›®æ ‡ >75%)
```

```bash
perf stat --topdown ./app          # Level 1
perf stat --topdown -v ./app       # Level 2
```

---

### ç¬¬ 39 ç« ï¼šVTune / Î¼Prof / LLVM-MCA

| å·¥å…· | ç‰¹è‰² |
|------|------|
| Intel VTune | Microarchitecture Exploration / Memory Access / Threading |
| AMD Î¼Prof | IBS ç²¾ç¡®é‡‡æ ·ï¼ˆAMD ç‹¬æœ‰ï¼‰/ L3 Slice åˆ†æ |
| LLVM-MCA | é™æ€åˆ†æç†è®ºååï¼Œæ— éœ€è¿è¡Œ |
| perf + FlameGraph | æœ€é€šç”¨ï¼Œç«ç„°å›¾å®šä½çƒ­ç‚¹ |

---

### ç¬¬ 40 ç« ï¼šä¼˜åŒ–æ¸…å•ä¸å»¶è¿Ÿé€ŸæŸ¥è¡¨

#### å»¶è¿Ÿé€ŸæŸ¥

| æ“ä½œ | å»¶è¿Ÿ |
|------|------|
| ADD/XOR | 1 cycle |
| IMUL | 3 cycles |
| **IDIV** | **20â€“90 cycles** |
| FP ADD/MUL | 4â€“5 cycles |
| **L1 Cache** | **4â€“5 cyc (~1ns)** |
| **L2 Cache** | **~12 cyc (~4ns)** |
| **L3 Cache** | **~40 cyc (~12ns)** |
| **DRAM** | **~200 cyc (~65ns)** |
| **Branch Miss** | **15â€“25 cycles** |
| syscall | ~300 cycles |
| Page Fault | ~10Kâ€“50K cycles |

#### ä¼˜åŒ–ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¼˜åŒ–å†…å®¹ | æ”¶ç›Š |
|--------|----------|------|
| æœ€é«˜ | ç®—æ³•å¤æ‚åº¦ O(NÂ²)â†’O(N logN) | æŒ‡æ•°çº§ |
| é«˜ | ç¼“å­˜å‹å¥½æ•°æ®ç»“æ„ | 5â€“20Ã— |
| ä¸­é«˜ | åˆ†å—/é¢„å–/å¯¹é½ | 2â€“10Ã— |
| ä¸­ | åˆ†æ”¯é¢„æµ‹ / ILP / SIMD | 1.5â€“8Ã— |
| ä½ | PGO / BOLT | 1.1â€“1.3Ã— |

**é»„é‡‘æ³•åˆ™ï¼šå…ˆæµ‹é‡ (`perf stat`)ï¼Œå†ä¼˜åŒ–ã€‚**

---

## æ·±å…¥åˆ†æä¸æ‰©å±•å»ºè®®

å½“å‰ 40 ç« å·²è¦†ç›– CPU å¾®æ¶æ„çš„æ ¸å¿ƒçŸ¥è¯†å›¾è°±ã€‚ä»¥ä¸‹ 6 ä¸ªæ–¹å‘å¯è¿›ä¸€æ­¥æ‰©å±•ï¼š

| æ‰©å±•ç« èŠ‚ | ä¸»é¢˜ | æ ¸å¿ƒå†…å®¹ |
|----------|------|----------|
| ç¬¬ 41 ç«  | æŠ•æœºæ‰§è¡Œå®‰å…¨ | Spectre/Meltdown, LFENCE, Retpoline, KPTI ä»£ä»· |
| ç¬¬ 42 ç«  | ç¡¬ä»¶é¢„å–å™¨ | L1/L2 Streamer/Spatial, æ­¥é•¿é™åˆ¶, æ‰‹åŠ¨é¢„å–æ—¶æœº |
| ç¬¬ 43 ç«  | SIMD å¾®æ¶æ„äº¤äº’ | AVX-512 é¢‘ç‡é™æ¡£, FMA, å¯„å­˜å™¨å‹åŠ› |
| ç¬¬ 44 ç«  | å†…å­˜å¸¦å®½åˆ†æ | STREAM benchmark, Roofline Model, å¸¦å®½é¥±å’Œç‚¹ |
| ç¬¬ 45 ç«  | å¤šè·¯ NUMA | è·¨ socket å»¶è¿Ÿ, numactl, first-touch ç­–ç•¥ |
| ç¬¬ 46 ç«  | ç¼–è¯‘å™¨å¾®æ¶æ„è®¤çŸ¥ | -march/mtune, PGO å®Œæ•´æµç¨‹, BOLT |

---

## æ¨èå‚è€ƒèµ„æ–™

- **Agner Fog** â€” *Optimizing Software in C++*ï¼ˆå…è´¹ PDFï¼Œæœ€æƒå¨ï¼‰
- **Intel** â€” *64 and IA-32 Architectures Optimization Reference Manual*
- **Hennessy & Patterson** â€” *Computer Architecture: A Quantitative Approach*
- [uops.info](https://uops.info) â€” x86 æŒ‡ä»¤ç²¾ç¡®å»¶è¿Ÿ/åå/ç«¯å£æ•°æ®
- [godbolt.org](https://godbolt.org) â€” å®æ—¶ç¼–è¯‘å™¨è¾“å‡º
- [Brendan Gregg](https://www.brendangregg.com/linuxperf.html) â€” Linux perf å·¥å…·é›†

---

*å‚ç…§ test14.cppï¼ˆ2895è¡Œï¼Œ40ç« ï¼‰ç¼–å†™*
