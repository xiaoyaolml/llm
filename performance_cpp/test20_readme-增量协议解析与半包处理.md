# test20：增量协议解析与半包处理

> 对应源码：`test20.cpp`
> 关联：补充 `test7` 中 HTTP 请求解析的工程化能力
> 标准：C++17

---

## 为什么新增这个专题

在真实 TCP 网络里，应用层消息常出现：

- 半包：一条消息被拆成多次 `recv` 才收齐。
- 粘包：多条消息在一次 `recv` 里同时到达。

如果解析器按“一次读取即完整请求”假设，服务端会出现随机解析失败或状态错乱。

---

## 本专题提供什么

`test20.cpp` 提供一个可重复调用的增量 HTTP 解析器：

1. 先识别 `\r\n\r\n`，得到完整头部边界；
2. 从头部提取 `Content-Length`；
3. 判断缓冲区是否已包含完整 body；
4. 若未收齐，返回“继续等待”；
5. 若收齐，产出一个完整请求并推进读指针；
6. 继续在同一缓冲区解析下一条请求（处理粘包）。

---

## 编译运行

```bash
g++ -std=c++17 -O2 -Wall -Wextra -o test20 test20.cpp && ./test20
# 或
cl /std:c++17 /O2 /EHsc test20.cpp
```

---

## 预期输出（示意）

- 第一次喂入半包：解析器返回 pending。
- 第二次补齐后：成功解析第一条 POST 请求与 body。
- 同一缓冲区继续解析：成功解析下一条 GET 请求。

---

## 与 test7 的关系

这个专题直接回应了 `test7` 的一个教学简化点：

- `test7` 更偏“概念演示”；
- `test20` 更偏“工程可用的消息边界管理”。

在后续扩展里，可以把该解析器接入 `SelectServer` 或 `HttpServer`，实现更稳健的 Keep-Alive 与流水线处理。
